======================================
PeekPoke Protocol.txt
25 April 2018
Chris Siedell
http://siedell.com/projects/PeekPoke/
======================================

PeekPoke is a tool for reading and writing the hub RAM of a Parallax Propeller 
P8X32A microcontroller from a computer. PeekPoke also has additional features:
    - getting the PAR register of the launched instance,
    - getting and setting the serial timings,
    - resetting the serial timings with a break condition, and
    - executing arbitrary code sent by the PC.

Some of these features may be disabled.

PeekPoke is designed to use the Crow serial transport layer, which facilitates
simple command and response protocols.

The suggested port number is 112 (ascii 'p').

The protocol identifier is "PeekPoke".


Break Detection
===============

In the default implementation the serial timings will be reset to the last
known good values when a break condition is detected. The last known good
values are saved every time a valid command is received, even if the command
is addressed to a different device or is too large for the device.

Break detection can be disabled.


Payload Format
==============

All commands have a four byte initial header: 0x70, 0x70, 0x00, and
commandCode. Any additional payload data depends on the command.

The response repeats the same initial four byte header.

Errors are reported using Crow-level error responses.

All multibyte values are in little-endian order.

These are the command codes:
    0 - getPar
    1 - readHub
    2 - writeHub
    3 - getSerialTimings
    4 - setSerialTimings
    5 - payloadExec
 

getPar
======

Command payload, 4 bytes:
        pos     len     description
        0       4       initial header

Response payload, 6 bytes:
        pos     len     description
        0       4       initial header
        4       2       par


readHub
=======

Command payload, 8 bytes:
        pos     len     description
        0       4       initial header
        4       2       address of read start, any alignment
        6       2       count = number of bytes to read, may be zero

Response payload, 4+count bytes:
        pos     len     description
        0       4       initial header
        4+      count   the bytes read


writeHub
========

Command payload, 8 bytes:
        pos     len     description
        0       4       initial header
        4       2       address of write start, any alignment
        6       2       count = number of bytes to write, may be zero
        8+      count   the bytes to write

Response payload, 4 bytes:
        pos     len     description
        0       4       initial header

A single write command can be considered atomic since the data is included in
a packet that is fully received into a buffer and checked for errors before
performing the command.


getSerialTimings
================

Command payload, 4 bytes:
        pos     len     description
        0       4       initial header

Response payload, 32 bytes:
        pos     len     description
        0       4       initial header
        4       4       bitPeriod0
        8       4       bitPeriod1
        12      4       startBitWait
        16      4       stopBitDuration
        20      4       interbyteTimeout
        24      4       recoveryTime
        28      4       breakMultiple

All timings are in system clocks except breakMultiple, which is the number of
recoveryTime intervals that the rx line must be continuously low before a break
condition is detected.


setSerialTimings
================

Command payload, 32 bytes:
        pos     len     description
        0       4       initial header
        4       4       bitPeriod0
        8       4       bitPeriod1
        12      4       startBitWait
        16      4       stopBitDuration
        20      4       interbyteTimeout
        24      4       recoveryTime
        28      4       breakMultiple

Response payload, 4 bytes:
        pos     len     description
        0       4       initial header

Changes take effect after the acknowledgement response is sent.


payloadExec
===========

Command payload, 8+ bytes:
        pos     len     description
        0       4       initial header
        4+      -       PASM code

Response payload, 4+ bytes (if sent):
        pos     len     description
        0       4       initial header
        4+      -       data

The payloadExec option requires a pre-arranged cog layout in order to work.

The PropCR-BD based implementation places the code starting at register 1,
and it may extend up through register 65 (so there can be up to 260 bytes of
instructions and data in the command). Execution will start at register 1. The
payload code must prepare its own response and call the sending routines when
done.

If a response is returned it must begin with the standard initial header.

